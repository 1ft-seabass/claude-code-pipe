---
tags: [webhook, error-handling, throttle, subscribers, logging]
---

# Webhook配信エラーハンドリング - 開発記録

> **⚠️ 機密情報保護ルール**
>
> このノートに記載する情報について:
> - API キー・パスワード・トークンは必ずプレースホルダー(`YOUR_API_KEY`等)で記載
> - 実際の機密情報は絶対に含めない
> - .env や設定ファイルの内容をそのまま転記しない

**作成日**: 2026-02-28
**関連タスク**: Webhook配信失敗時のエラーハンドリング強化

## 問題

Webhook配信先が応答しない、またはエラーを返す場合に、エラーログが大量に出力される問題があった。

### 具体的な課題
- 配信先が一時的にダウンしている場合、同じエラーが連続して出力される
- ログが埋め尽くされて重要な情報が見づらくなる
- リトライは不要（接続できない検知ができればよい）

## 解決策

**直近5分以内の重複エラーを抑制する仕組み**を実装した。

### 実装場所
`src/subscribers.js`

### 主なポイント

1. **エラー履歴の管理**
   - `Map` を使ってエラー履歴を記録
   - キー: `${label}:${url}` （エンドポイント単位で管理）
   - 値: タイムスタンプ

2. **エラー抑制ロジック**
   - 直近5分以内に同じエラーが出ていたらログ出力をスキップ
   - 5分経過後は再度警告を出力

3. **実装コード**

```javascript
// エラー履歴管理（直近のエラーを記録して重複警告を防ぐ）
const errorHistory = new Map(); // key: `${label}:${url}`, value: timestamp
const ERROR_THROTTLE_MS = 5 * 60 * 1000; // 5分間同じエラーを抑制

/**
 * エラーログを出力（直近に同じエラーが出ていなければ）
 */
function logErrorIfNeeded(message, label, url) {
  const key = `${label}:${url}`;
  const now = Date.now();
  const lastErrorTime = errorHistory.get(key);

  // 直近5分以内に同じエラーが出ていたらスキップ
  if (lastErrorTime && (now - lastErrorTime) < ERROR_THROTTLE_MS) {
    return;
  }

  // エラーログを出力
  console.error(`[subscribers] ${message}`);

  // エラー履歴を更新
  errorHistory.set(key, now);
}
```

4. **適用箇所**
   - HTTP ステータスコード 400以上のエラー
   - ネットワークエラー（`req.on('error')`）
   - URL パースエラー

## 学び

### シンプルな解決策の有効性
- リトライ機構を実装する必要はなかった
- エラー検知と抑制で十分に要件を満たせた
- `Map` による簡潔な履歴管理で実装できた

### エラーハンドリングの粒度
- エンドポイント単位（`${label}:${url}`）で管理することで、他のエンドポイントには影響しない
- 配信先ごとに独立してエラー管理できる

### タイムウィンドウの設定
- 5分間という設定は適度に警告を抑制しつつ、長期間のエラーを見逃さない
- 必要に応じて `ERROR_THROTTLE_MS` を調整可能

## 今後の改善案

### エラーカウントの記録
- 抑制されたエラーの回数をカウントして定期的にレポート
- 例: 「直近5分で50回のエラーを抑制しました」

### エラータイプの分類
- ネットワークエラー vs HTTPエラー
- エラータイプごとに異なる抑制時間を設定

### メトリクス収集
- Webhook配信の成功率・失敗率を記録
- ダッシュボードで可視化

## 関連ドキュメント

- [追加イベントシステム実装](./2026-02-28-04-05-00-additional-session-events.md)
- [前回の申し送り](../letters/2026-02-23-13-55-00-sender-improvements-and-event-system.md)

---

**最終更新**: 2026-02-28
**作成者**: Claude Code (AI)
